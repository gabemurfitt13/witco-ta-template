<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Supported Employment Data Sheet</title>

<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
body { margin:0; background:#f6f7fb; color:#111; }
.wrap { max-width:1100px; margin:16px auto; padding:12px; }
.card { background:#fff; border:1px solid #e6e8f0; border-radius:12px; padding:12px; }

label{display:block;font-size:11px;color:#444;margin-bottom:5px}
input,textarea,select{
  width:100%; box-sizing:border-box; padding:8px 9px;
  border:1px solid #d7dbea; border-radius:10px; background:#fff;
  font-size:13px;
}
textarea{min-height:54px;resize:none;overflow:hidden}

.btnbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
button{
  border:1px solid #d7dbea;background:#111;color:#fff;
  padding:8px 10px;border-radius:10px;cursor:pointer;font-size:13px;
}
button.secondary{background:#fff;color:#111}
button.ok{background:#157f3b;border-color:#157f3b}
button.warn{background:#b36b00;border-color:#b36b00}

.req-bad{
  border-color:#b42318 !important;
  box-shadow:0 0 0 2px rgba(180,35,24,.12) !important;
}

.sigcanvas{
  width:100%;
  height:160px;
  border:1px dashed #cfd6ee;
  border-radius:10px;
  touch-action:none;
  display:block;
}
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<h2>Supported Employment Data Sheet</h2>

<label>Work Location</label>
<input id="workLocation">

<label>Date (MM/DD/YYYY)</label>
<input id="entryDateUS" placeholder="MM/DD/YYYY">

<label>Time In</label>
<input id="timeIn" type="time">

<label>Time Out</label>
<input id="timeOut" type="time">

<label>Total Time (auto)</label>
<input id="totalTime" readonly>

<hr>

<h3>Tasks</h3>
<table width="100%">
<tbody id="tasksBody"></tbody>
</table>
<div class="btnbar">
<button id="addTask" class="secondary">Add Task</button>
</div>

<hr>

<h3>Goals</h3>
<table width="100%">
<tbody id="goalsBody"></tbody>
</table>
<div class="btnbar">
<button id="addGoal" class="secondary">Add Goal</button>
</div>

<hr>

<h3>Client Signature</h3>
<canvas id="clientCanvas" class="sigcanvas"></canvas>

<label>Printed Name</label>
<input id="clientPrinted">

<div class="btnbar">
<button id="clientClear" class="secondary">Clear</button>
<button id="clientSign" class="ok">Client Sign (locks)</button>
</div>

</div>
</div>

<script>
// =====================================================
// TIME CALC
// =====================================================
function minutesBetween(t1,t2){
  if(!t1||!t2) return null;
  const [h1,m1]=t1.split(":").map(Number);
  const [h2,m2]=t2.split(":").map(Number);
  let a=h1*60+m1,b=h2*60+m2;
  if(b<a) b+=1440;
  return b-a;
}

function minutesToQuarterHours(min){
  if(min==null) return "";
  const rounded=Math.round(min/15)*15;
  return (rounded/60).toFixed(2);
}

function recalcTotalTime(){
  const mins=minutesBetween(timeIn.value,timeOut.value);
  totalTime.value=minutesToQuarterHours(mins);
}

timeIn.oninput=timeOut.oninput=recalcTotalTime;

// =====================================================
// TASKS
// =====================================================
function addTaskRow(data={}){
  const tr=document.createElement("tr");

  tr.innerHTML=`
    <td><input placeholder="Task..." value="${data.title||""}"></td>
    <td>
      <select>
        <option value=""></option>
        <option>I</option><option>IR</option><option>VI</option>
        <option>M</option><option>P</option><option>R</option>
      </select>
    </td>
    <td><input placeholder="Note..." value="${data.note||""}"></td>
    <td><button type="button">Remove</button></td>
  `;

  tr.querySelector("button").onclick=()=>tr.remove();
  tasksBody.appendChild(tr);
}
addTask.onclick=()=>addTaskRow();

// =====================================================
// GOALS + PROMPTS
// =====================================================
function addPromptLine(container,p={}){
  const line=document.createElement("div");
  line.className="supportLine";
  line.innerHTML=`
    <select>
      <option value=""></option>
      <option>I</option><option>IR</option><option>VI</option>
      <option>M</option><option>P</option><option>R</option>
    </select>
    <input type="number" min="1" placeholder="Count" value="${p.count||1}">
    <button type="button">X</button>
  `;
  line.querySelector("button").onclick=()=>line.remove();
  container.appendChild(line);
}

function addGoalRow(data={}){
  const tr=document.createElement("tr");

  const promptWrap=document.createElement("div");
  promptWrap.className="supportLines";
  addPromptLine(promptWrap,{});

  tr.innerHTML=`
    <td><textarea placeholder="Goal...">${data.title||""}</textarea></td>
    <td></td>
    <td><textarea placeholder="Anecdotal...">${data.note||""}</textarea></td>
    <td><button type="button">Remove</button></td>
  `;

  tr.children[1].appendChild(promptWrap);

  tr.querySelector("button").onclick=()=>tr.remove();
  goalsBody.appendChild(tr);
}
addGoal.onclick=()=>addGoalRow();

// =====================================================
// SIGNATURE PAD (mobile safe)
// =====================================================
function createSigPad(canvas){
  const ctx=canvas.getContext("2d");
  let drawing=false,last=null;

  function pos(e){
    const r=canvas.getBoundingClientRect();
    return{x:e.clientX-r.left,y:e.clientY-r.top};
  }

  canvas.onpointerdown=e=>{
    drawing=true;
    last=pos(e);
    canvas.setPointerCapture(e.pointerId);
  };

  canvas.onpointermove=e=>{
    if(!drawing) return;
    const p=pos(e);
    ctx.lineWidth=2;
    ctx.lineCap="round";
    ctx.beginPath();
    ctx.moveTo(last.x,last.y);
    ctx.lineTo(p.x,p.y);
    ctx.stroke();
    last=p;
  };

  canvas.onpointerup=canvas.onpointercancel=()=>drawing=false;

  return{
    clear(){ctx.clearRect(0,0,canvas.width,canvas.height)},
    hasInk(){
      const pixels=ctx.getImageData(0,0,canvas.width,canvas.height).data;
      return pixels.some(v=>v!==0);
    }
  };
}

const clientPad=createSigPad(clientCanvas);

// =====================================================
// ðŸ”¥ CONDITIONAL REQUIRED LOGIC (YOUR RULE)
// =====================================================
function requireForClientLock(){

  document.querySelectorAll(".req-bad")
    .forEach(x=>x.classList.remove("req-bad"));

  const missing=[];
  const bad=(node,msg)=>{node?.classList.add("req-bad");missing.push(msg)};

  const tasks=[...tasksBody.querySelectorAll("tr")];
  const goals=[...goalsBody.querySelectorAll("tr")];

  // detect activity
  const hasTask=tasks.some(tr=>{
    const i=tr.querySelectorAll("input,select");
    return i[0].value||i[1].value||i[2].value;
  });

  const hasGoal=goals.some(tr=>{
    const tas=tr.querySelectorAll("textarea");
    return tas[0].value||tas[1].value;
  });

  const hasWork=hasTask||hasGoal;

  // time required if work exists
  if(hasWork){
    if(!timeIn.value) bad(timeIn,"Time In required");
    if(!timeOut.value) bad(timeOut,"Time Out required");
    if(!totalTime.value) bad(totalTime,"Total Time missing");
  }

  // task completeness
  tasks.forEach((tr,i)=>{
    const ixs=tr.querySelectorAll("input,select");
    const used=ixs[0].value||ixs[1].value||ixs[2].value;
    if(!used) return;

    if(!ixs[0].value) bad(ixs[0],`Task ${i+1} text required`);
    if(!ixs[1].value) bad(ixs[1],`Task ${i+1} support required`);
    if(!ixs[2].value) bad(ixs[2],`Task ${i+1} note required`);
  });

  // goal completeness
  goals.forEach((tr,i)=>{
    const tas=tr.querySelectorAll("textarea");
    const used=tas[0].value||tas[1].value;
    if(!used) return;

    if(!tas[0].value) bad(tas[0],`Goal ${i+1} text required`);
    if(!tas[1].value) bad(tas[1],`Goal ${i+1} anecdotal required`);

    const lines=[...tr.querySelectorAll(".supportLine")];
    let ok=false;

    lines.forEach(line=>{
      const sel=line.querySelector("select");
      const cnt=line.querySelector("input");
      if(sel.value&&cnt.value>0) ok=true;
    });

    if(!ok) missing.push(`Goal ${i+1} needs prompt`);
  });

  // base fields
  if(!workLocation.value.trim()) bad(workLocation,"Work Location required");
  if(!entryDateUS.value.trim()) bad(entryDateUS,"Date required");
  if(!clientPrinted.value.trim()) bad(clientPrinted,"Printed name required");
  if(!clientPad.hasInk()) missing.push("Client signature required");

  if(missing.length){
    alert("Client Sign blocked:\n\n- "+[...new Set(missing)].join("\n- "));
    return false;
  }
  return true;
}

// =====================================================
// SIGN BUTTON
// =====================================================
clientSign.onclick=()=>{
  if(!requireForClientLock()) return;
  alert("Client signed and form locked.");
};

clientClear.onclick=()=>clientPad.clear();

</script>
</body>
</html>
