<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Electronic Task Analysis (TA)</title>
  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --card:#ffffff;
      --bg:#f8fafc;
      --accent:#7a0019; /* subtle maroon */
      --radius:14px;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--ink); background:var(--bg);
      padding:22px;
    }
    .wrap{max-width:1000px;margin:0 auto}
    header{
      display:flex; gap:16px; align-items:flex-start; justify-content:space-between;
      margin-bottom:16px;
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand h1{
      margin:0; font-size:20px; letter-spacing:.2px;
    }
    .brand .sub{
      color:var(--muted); font-size:13px;
    }
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    button{
      border:1px solid var(--line);
      background:var(--card);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    button.primary{
      border-color:transparent;
      background:var(--accent);
      color:#fff;
    }
    button:active{transform:translateY(1px)}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin-bottom:14px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.2px}
    input, textarea, select{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 11px;
      font:inherit;
      background:#fff;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    .span-3{grid-column:span 3}
    .span-4{grid-column:span 4}
    .span-5{grid-column:span 5}
    .span-6{grid-column:span 6}
    .span-7{grid-column:span 7}
    .span-8{grid-column:span 8}
    .span-9{grid-column:span 9}
    .span-12{grid-column:span 12}

    .divider{
      height:1px; background:linear-gradient(to right, transparent, var(--line), transparent);
      margin:14px 0;
    }

    table{width:100%; border-collapse:separate; border-spacing:0}
    th, td{
      border:1px solid var(--line);
      padding:10px;
      vertical-align:top;
      background:#fff;
    }
    th{
      background:#fafafa;
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    table tr:first-child th:first-child{border-top-left-radius:12px}
    table tr:first-child th:last-child{border-top-right-radius:12px}
    table tr:last-child td:first-child{border-bottom-left-radius:12px}
    table tr:last-child td:last-child{border-bottom-right-radius:12px}
    .mini{
      font-size:12px; color:var(--muted);
    }
    .row-actions{
      display:flex; gap:10px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap;
    }

    /* signature */
    .sig-wrap{
      display:grid; gap:10px;
      grid-template-columns: 1fr;
    }
    .sig-box{
      border:1px dashed #cfd6ee;
      border-radius:12px;
      background:
        linear-gradient(to bottom, transparent 0 78%, rgba(0,0,0,.08) 78% 79%, transparent 79% 100%);
      height:170px;
      touch-action:none;
      position:relative;
      overflow:hidden;
    }
    canvas{width:100%; height:100%}
    .sig-meta{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      align-items:end;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      background:#f3f4f6; color:#374151;
      font-size:12px; font-weight:700;
      border:1px solid var(--line);
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent)}
    footer{
      text-align:center; color:var(--muted); font-size:12px; padding:10px 0 0;
    }

    /* print */
    @media print{
      body{background:#fff; padding:0}
      .actions{display:none !important}
      .card{box-shadow:none}
      input, textarea, select{border:1px solid #d1d5db}
      .sig-box{border:1px solid #d1d5db}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Electronic Task Analysis (TA)</h1>
        <div class="sub">Fill it out, capture signature, then print/save as PDF. Humans love paperwork.</div>
      </div>
      <div class="actions">
        <button type="button" id="btnAddRow">+ Add Step</button>
        <button type="button" id="btnClearSig">Clear Signature</button>
        <button type="button" id="btnSave">Save Draft</button>
        <button type="button" class="primary" id="btnPrint">Print / Save PDF</button>
      </div>
    </header>

    <section class="card">
      <div class="grid">
        <div class="field span-4">
          <label>Client Name</label>
          <input id="clientName" placeholder="Client" />
        </div>
        <div class="field span-4">
          <label>Coach Name</label>
          <input id="coachName" placeholder="Job Coach" />
        </div>
        <div class="field span-4">
          <label>Date</label>
          <input id="serviceDate" type="date" />
        </div>

        <div class="field span-6">
          <label>Employer / Site</label>
          <input id="site" placeholder="Employer / Location" />
        </div>
        <div class="field span-3">
          <label>Shift Start</label>
          <input id="startTime" type="time" />
        </div>
        <div class="field span-3">
          <label>Shift End</label>
          <input id="endTime" type="time" />
        </div>

        <div class="field span-12">
          <label>Job / Task Being Analyzed</label>
          <input id="jobTask" placeholder="e.g., Stocking shelves, booth setup, dish room, etc." />
        </div>
      </div>

      <div class="divider"></div>

      <div class="mini">
        Use the table to break the task into steps. Keep it observable and concrete (no mind-reading).
      </div>
    </section>

    <section class="card">
      <table id="taTable">
        <thead>
          <tr>
            <th style="width:70px;">Step #</th>
            <th>Task Step (what the client does)</th>
            <th style="width:220px;">Supports / Prompts (if needed)</th>
            <th style="width:220px;">Notes / Quality Criteria</th>
            <th style="width:70px;">Del</th>
          </tr>
        </thead>
        <tbody id="taBody">
          <!-- rows injected -->
        </tbody>
      </table>

      <div class="row-actions">
        <span class="pill"><span class="dot"></span> Keep it simple, keep it defensible</span>
      </div>
    </section>

    <section class="card">
      <div class="grid">
        <div class="field span-12">
          <label>Session Notes</label>
          <textarea id="notes" placeholder="What happened? What worked? What changed? Anything relevant."></textarea>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="grid">
        <div class="field span-12">
          <label>Client Signature</label>
          <div class="sig-wrap">
            <div class="sig-box">
              <canvas id="sigCanvas"></canvas>
            </div>
            <div class="sig-meta">
              <div class="field span-6">
                <label>Signature Name (typed)</label>
                <input id="sigName" placeholder="Type name (optional)" />
              </div>
              <div class="field span-6">
                <label>Device / Method (optional)</label>
                <input id="sigMethod" placeholder="Mouse / touch / stylus" />
              </div>
            </div>
            <div class="mini">
              Tip: If you need this to look “more official,” you can also print it and have them sign with ink. Paper never crashes.
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer>
      Drafts save to this browser only (localStorage). Printing uses your browser’s PDF save.
    </footer>
  </div>

<script>
  // ---------- TA table ----------
  const taBody = document.getElementById('taBody');

  function makeCellInput(placeholder){
    const inp = document.createElement('input');
    inp.placeholder = placeholder;
    inp.addEventListener('input', autoSaveLight);
    return inp;
  }

  function makeCellTextarea(placeholder){
    const ta = document.createElement('textarea');
    ta.placeholder = placeholder;
    ta.style.minHeight = '44px';
    ta.addEventListener('input', autoSaveLight);
    return ta;
  }

  function addRow(stepNum=null, stepVal="", supportVal="", notesVal=""){
    const tr = document.createElement('tr');

    const tdNum = document.createElement('td');
    tdNum.style.textAlign = 'center';
    tdNum.style.fontWeight = '800';
    tdNum.textContent = stepNum ?? (taBody.children.length + 1);

    const tdStep = document.createElement('td');
    const step = makeCellTextarea("Describe the step…");
    step.value = stepVal;
    tdStep.appendChild(step);

    const tdSupport = document.createElement('td');
    const support = makeCellTextarea("Prompts / supports…");
    support.value = supportVal;
    tdSupport.appendChild(support);

    const tdNotes = document.createElement('td');
    const n = makeCellTextarea("Quality criteria / notes…");
    n.value = notesVal;
    tdNotes.appendChild(n);

    const tdDel = document.createElement('td');
    tdDel.style.textAlign = 'center';
    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.textContent = 'X';
    delBtn.addEventListener('click', () => {
      tr.remove();
      renumberRows();
      autoSaveLight();
    });
    tdDel.appendChild(delBtn);

    tr.append(tdNum, tdStep, tdSupport, tdNotes, tdDel);
    taBody.appendChild(tr);
    renumberRows();
  }

  function renumberRows(){
    [...taBody.children].forEach((tr, idx) => {
      tr.children[0].textContent = idx + 1;
    });
  }

  document.getElementById('btnAddRow').addEventListener('click', () => addRow());

  // Seed with a few rows
  addRow(1);
  addRow(2);
  addRow(3);

  // ---------- Signature pad ----------
  const canvas = document.getElementById('sigCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let last = {x:0, y:0};

  function resizeCanvas(){
    // match canvas pixels to element size for crisp drawing
    const box = canvas.getBoundingClientRect();
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const data = canvas.toDataURL(); // keep existing signature when resizing
    canvas.width = Math.floor(box.width * ratio);
    canvas.height = Math.floor(box.height * ratio);
    canvas.style.width = box.width + 'px';
    canvas.style.height = box.height + 'px';
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);

    // restore
    const img = new Image();
    img.onload = () => ctx.drawImage(img, 0, 0, box.width, box.height);
    img.src = data;
  }

  function pos(evt){
    const rect = canvas.getBoundingClientRect();
    const p = evt.touches ? evt.touches[0] : evt;
    return { x: p.clientX - rect.left, y: p.clientY - rect.top };
  }

  function startDraw(evt){
    drawing = true;
    last = pos(evt);
    evt.preventDefault();
  }

  function draw(evt){
    if(!drawing) return;
    const p = pos(evt);
    ctx.lineWidth = 2.2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#111827';
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    last = p;
    evt.preventDefault();
    autoSaveLight();
  }

  function endDraw(){
    drawing = false;
  }

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  window.addEventListener('mouseup', endDraw);

  canvas.addEventListener('touchstart', startDraw, {passive:false});
  canvas.addEventListener('touchmove', draw, {passive:false});
  canvas.addEventListener('touchend', endDraw);

  document.getElementById('btnClearSig').addEventListener('click', () => {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    autoSaveLight();
  });

  window.addEventListener('resize', resizeCanvas);
  setTimeout(resizeCanvas, 50);

  // ---------- Save / Load (localStorage) ----------
  const KEY = "electronic_ta_draft_v1";

  function collectRows(){
    return [...taBody.children].map(tr => ({
      step: tr.children[1].querySelector('textarea').value,
      supports: tr.children[2].querySelector('textarea').value,
      notes: tr.children[3].querySelector('textarea').value
    }));
  }

  function fillRows(rows){
    taBody.innerHTML = "";
    rows.forEach((r, i) => addRow(i+1, r.step, r.supports, r.notes));
  }

  function getFormData(){
    return {
      clientName: document.getElementById('clientName').value,
      coachName: document.getElementById('coachName').value,
      serviceDate: document.getElementById('serviceDate').value,
      site: document.getElementById('site').value,
      startTime: document.getElementById('startTime').value,
      endTime: document.getElementById('endTime').value,
      jobTask: document.getElementById('jobTask').value,
      notes: document.getElementById('notes').value,
      sigName: document.getElementById('sigName').value,
      sigMethod: document.getElementById('sigMethod').value,
      taRows: collectRows(),
      sigDataUrl: canvas.toDataURL()
    };
  }

  function setFormData(d){
    document.getElementById('clientName').value = d.clientName || "";
    document.getElementById('coachName').value = d.coachName || "";
    document.getElementById('serviceDate').value = d.serviceDate || "";
    document.getElementById('site').value = d.site || "";
    document.getElementById('startTime').value = d.startTime || "";
    document.getElementById('endTime').value = d.endTime || "";
    document.getElementById('jobTask').value = d.jobTask || "";
    document.getElementById('notes').value = d.notes || "";
    document.getElementById('sigName').value = d.sigName || "";
    document.getElementById('sigMethod').value = d.sigMethod || "";
    if(Array.isArray(d.taRows) && d.taRows.length) fillRows(d.taRows);

    // restore signature
    if(d.sigDataUrl){
      const img = new Image();
      img.onload = () => {
        const box = canvas.getBoundingClientRect();
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, box.width, box.height);
      };
      img.src = d.sigDataUrl;
    }
  }

  function saveDraft(){
    const data = getFormData();
    localStorage.setItem(KEY, JSON.stringify(data));
  }

  function loadDraft(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    try{
      const data = JSON.parse(raw);
      setFormData(data);
    }catch(e){
      // ignore
    }
  }

  // Light autosave so typing doesn't feel laggy
  let t = null;
  function autoSaveLight(){
    clearTimeout(t);
    t = setTimeout(saveDraft, 300);
  }

  document.getElementById('btnSave').addEventListener('click', () => {
    saveDraft();
    alert("Draft saved on this browser.");
  });

  // Save on key fields
  ["clientName","coachName","serviceDate","site","startTime","endTime","jobTask","notes","sigName","sigMethod"]
    .forEach(id => document.getElementById(id).addEventListener('input', autoSaveLight));

  loadDraft();

  // ---------- Print ----------
  document.getElementById('btnPrint').addEventListener('click', () => {
    saveDraft();
    window.print();
  });
</script>
</body>
</html>
